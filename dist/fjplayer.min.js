/* Fjplayer is a copyright @ EASYSOFTIN */
var Base64={};Base64.code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";Base64.encode=function(str,utf8encode){utf8encode=typeof utf8encode=="undefined"?false:utf8encode;var o1,o2,o3,bits,h1,h2,h3,h4,e=[],pad="",c,plain,coded;var b64=Base64.code;plain=utf8encode?Utf8.encode(str):str;c=plain.length%3;if(c>0){while(c++<3){pad+="=";plain+="\0"}}for(c=0;c<plain.length;c+=3){o1=plain.charCodeAt(c);o2=plain.charCodeAt(c+1);o3=plain.charCodeAt(c+2);bits=o1<<16|o2<<8|o3;h1=bits>>18&63;h2=bits>>12&63;h3=bits>>6&63;h4=bits&63;e[c/3]=b64.charAt(h1)+b64.charAt(h2)+b64.charAt(h3)+b64.charAt(h4)}coded=e.join("");coded=coded.slice(0,coded.length-pad.length)+pad;return coded};Base64.decode=function(str,utf8decode){utf8decode=typeof utf8decode=="undefined"?false:utf8decode;var o1,o2,o3,h1,h2,h3,h4,bits,d=[],plain,coded;var b64=Base64.code;coded=utf8decode?Utf8.decode(str):str;for(var c=0;c<coded.length;c+=4){h1=b64.indexOf(coded.charAt(c));h2=b64.indexOf(coded.charAt(c+1));h3=b64.indexOf(coded.charAt(c+2));h4=b64.indexOf(coded.charAt(c+3));bits=h1<<18|h2<<12|h3<<6|h4;o1=bits>>>16&255;o2=bits>>>8&255;o3=bits&255;d[c/4]=String.fromCharCode(o1,o2,o3);if(h4==64)d[c/4]=String.fromCharCode(o1,o2);if(h3==64)d[c/4]=String.fromCharCode(o1)}plain=d.join("");return utf8decode?Utf8.decode(plain):plain};Base64.UTF8_encode=function(s){var u=[];for(var i=0;i<s.length;++i){var c=s.charCodeAt(i);if(c<128){u.push(c)}else if(c<2048){u.push(192|c>>6);u.push(128|63&c)}else if(c<65536){u.push(224|c>>12);u.push(128|63&c>>6);u.push(128|63&c)}else{u.push(240|c>>18);u.push(128|63&c>>12);u.push(128|63&c>>6);u.push(128|63&c)}}return u};Base64.BinToArray=function(bin){var Akeyid=new Uint8Array(bin.length);for(var k=0;k<bin.length;k++){Akeyid[k]=bin.charCodeAt(k)}return Akeyid};"use strict";angular.module("fjplayer",[]).controller("fjplayerCtrl",["$scope","$filter","$interval","$document","$timeout","$sce","$window",function($scope,$filter,$interval,$document,$timeout,$sce,$window){$scope.fjplayerTag="Fjplayer ";$scope.tdObj;$scope.tiObj;$scope.pbObj;$scope.volObj;$scope.menuObj;$scope.playerItems;$scope.settingBtn;$scope.medias=new Array;$scope.VolumeMgr;$scope.settingMenuMgr;$scope.thumbMgr;$scope.overlays=new Array;$scope.isPlaylist=false;$scope.isPlaylistLoop=false;$scope.PlaylistCurrentIndex=0;$scope.isFullScreen=false;$scope.isFullScreenSupported=true;$scope.isVideoSeeking=false;$scope.moviePoster="";$scope.status="Loading ....";$scope.dash_context=null;$scope.dash_player=null;$scope.videoReady=false;$scope.showingVolumeBar=false;$scope.usingVolumeBar=false;$scope.isPlaying=false;$scope.isVideoisAds=false;$scope.isContainsSubs=false;$scope.isContainsLangs=false;$scope.isContainsThumbs=false;$scope.VolLevelUp=true;$scope.VolLevelDown=false;$scope.VolLevelOff=false;$scope.prgressPercentage=0;$scope.volumePercentage=80;$scope.movieTitle="";$scope.isAdsDataHidden=true;$scope.isAdsInfoHidden=true;$scope.thumbTime=0;$scope.tracksArray={subs:[],audio:[]};$scope.movieCTime=0;$scope.movieTTime=0;$scope.movieBuffered=0;$scope.volume=0;$scope.idleMouseTimer;$scope.isCursorHidden=false;$scope.AdsData="";$scope.AdsInfo="";$scope.prepareUI=function(){$scope.tdObj=document.getElementById("thumbDiv");$scope.tiObj=document.getElementById("thumbImgBlock");$scope.pbObj=document.getElementById("hprogressbar");$scope.video=document.getElementById("fjVidMain");$scope.volObj=document.getElementById("vprogressbar");$scope.menuObj=document.getElementById("settingMenuDiv");$scope.settingBtn=document.getElementById("subsBtnId");if(!$scope.video.requestFullscreen&&!$scope.video.mozRequestFullScreen&&!$scope.video.webkitRequestFullScreen){$scope.isFullScreenSupported=false}};$scope.fjMouseMgr=function($event){$scope.isCursorHidden=false;$timeout.cancel($scope.idleMouseTimer);$scope.idleMouseTimer=$timeout(function(){$scope.isCursorHidden=true},3e3)};$scope.checkPlaylistAndStart=function(items,startIdx){if(items==null){console.error("BAD conf , no media found !");console.error(items)}$scope.isPlaylistLoop=angular.fromJson(items).loop;$scope.playerItems=angular.fromJson(items).playlist;console.debug($scope.playerItems.length);if($scope.playerItems.length==0){console.error("No items to play !!");return}if($scope.playerItems.length>1){$scope.isPlaylist=true}else{console.debug("length of items is ",$scope.playerItems.length);$scope.isPlaylist=false}$scope.SetVideoEvents();$scope.VolumeMgr=new $scope.fjVolume($scope.volObj);for(var i=0;i<$scope.playerItems.length;i++){$scope.medias[i]=new $scope.fjVideo($scope.playerItems[i])}$scope.PlaylistCurrentIndex=startIdx;console.debug($scope.PlaylistCurrentIndex,$scope.medias[$scope.PlaylistCurrentIndex].media);$scope.medias[$scope.PlaylistCurrentIndex].Startup();$scope.medias[$scope.PlaylistCurrentIndex].setTracks();$scope.medias[$scope.PlaylistCurrentIndex].View()};$scope.fjVolume=function(volumebar){this.vb=volumebar,this.goShowProgressBar=function(){$timeout(function(){if($scope.usingVolumeBar==false){$scope.showingVolumeBar=false}},1e3)},this.goShowVolumeBar=function(){this.vb.style.display="block";$scope.showingVolumeBar=true},this.goUseVolumeBar=function(){$scope.usingVolumeBar=true},this.goHideVolumeBar=function(){$scope.usingVolumeBar=false;$scope.showingVolumeBar=false;$scope.volumePercentage=100},this.goMuteVolume=function(){if($scope.volumePercentage==0)this.setVolume(100);else this.setVolume(0)},this.setVolumeProgressLevel=function($event){var bv=document.getElementById("vprogressbar");var rect=bv.getBoundingClientRect();var vp=($event.pageX-rect.left)/rect.width*100;this.setVolume(vp)},this.setVolume=function(newVolumePercentage){$scope.video.volume=newVolumePercentage/100;$scope.volumePercentage=newVolumePercentage;if(newVolumePercentage==0){$scope.VolLevelUp=false;$scope.VolLevelDown=false;$scope.VolLevelOff=true}else if(newVolumePercentage>60){$scope.VolLevelUp=true;$scope.VolLevelDown=false;$scope.VolLevelOff=false}else{$scope.VolLevelUp=false;$scope.VolLevelDown=true;$scope.VolLevelOff=false}}};$scope.fjSettingMenu=function(menuObj,settingBtnObj){this.menudiv=menuObj,this.menuBtn=settingBtnObj,this.goSettingMenu=function(){if(this.menudiv.style.visibility=="visible")this.menudiv.style.visibility="hidden";var rect=this.menuBtn.getBoundingClientRect();this.menudiv.style.left=rect.left+"px";this.menudiv.style.top=rect.top-rect.height*Math.max($scope.tracksArray.subs.length,$scope.tracksArray.audio.length)+"px";this.menudiv.style.visibility="visible"},this.setSubs=function(index){for(var i=0;i<$scope.tracksArray.subs.length;i++){if($scope.tracksArray.subs[i].index==index){$scope.tracksArray.subs[i].actif=true}else{$scope.tracksArray.subs[i].actif=false}}for(var i=0;i<$scope.video.textTracks.length;i++){if(i==index){$scope.video.textTracks[i].mode="showing"}else{$scope.video.textTracks[i].mode="hidden"}}this.menudiv.style.visibility="hidden"},this.setAudio=function(index){for(var i=0;i<$scope.tracksArray.audio.length;i++){if($scope.tracksArray.audio[i].index==index)$scope.tracksArray.audio[i].actif=true;else $scope.tracksArray.audio[i].actif=false}for(var i=0;i<$scope.video.videoTracks.length;i++){if(i==index){$scope.video.videoTracks[i].selected=true}else{$scope.video.videoTracks[i].selected=false}}this.menudiv.style.visibility="hidden"}};$scope.fjThumbs=function(thumbImg,thumbDiv,progressBar){this.td=thumbDiv,this.t=thumbImg,this.b=progressBar,this.goShowThumbs=function(){this.td.style.visibility="visible"},this.goHideThumbs=function(){this.td.style.visibility="hidden"},this.goRenderThumbs=function($event){var rect=this.b.getBoundingClientRect();var p=($event.pageX-rect.left)*($scope.video.duration/(rect.right-rect.left));if(p>$scope.video.duration+2||p<0){console.error(" Position is bigger than duration >>",p,scope.video.duration);return}$scope.thumbTime=p;var c=$scope.video.textTracks[$scope.indexThumbsTrack].cues;if(c==null){console.error(" cues is null @ ",$scope.indexThumbsTrack," not supported , Firefox ?");return}for(var i=0;i<c.length;i++){if(c[i].startTime<=p&&c[i].endTime>p){break}}var url=c[i].text.split("#")[0];var xywh=c[i].text.substr(c[i].text.indexOf("=")+1).split(",");this.t.style.backgroundImage="url("+c[i].text.split("#")[0]+")";this.t.style.backgroundPosition="-"+xywh[0]+"px -"+xywh[1]+"px";this.t.style.width=xywh[2]+"px";this.t.style.height=xywh[3]+"px";this.td.style.left=$event.pageX-xywh[2]/2+"px";this.td.style.top=rect.top-xywh[3]*1.5+"px";this.td.style.width=xywh[2]+"px"}};$scope.fjOverlays=function(_data,_showAt,_showDuration,_animate){var adData=_data,showAt=_showAt,showDuration=_showDuration,animate=_animate,started=false,finished=false,refreshId=null,handler=null,txtduration,onTmUpdate=function(e){$scope.$apply(function(){if(!started&&$scope.video.currentTime>showAt&&$scope.video.currentTime<showAt+1){started=true;if(showDuration==-1)showDuration=Math.trunc($scope.video.duration);StartAds();refreshId=$interval(upInfo,1e3);console.debug(">> refreshId",refreshId);return}})},trigger=function(){$scope.isAdsDataHidden=true;$scope.isAdsInfoHidden=true;txtduration=$filter("duration")(showDuration);handler=onTmUpdate.bind($scope.video);$scope.video.addEventListener("timeupdate",handler,false)},upInfo=function(){if(showDuration>0){$scope.AdsInfo=$sce.trustAsHtml("your ads will end in "+txtduration+" sec");showDuration--;txtduration=$filter("duration")(showDuration)}else{console.debug("Ending @@@ ",showDuration);$scope.isAdsDataHidden=true;$scope.isAdsInfoHidden=true;finished=true;console.debug(" Finishing Overlay >> refreshId",refreshId);$interval.cancel(refreshId);$scope.video.removeEventListener("timeupdate",handler,false)}},StartAds=function(){var secTimeout=showDuration*1e3;txtduration=$filter("duration")(showDuration);$scope.AdsInfo=$sce.trustAsHtml("you ads will end in "+txtduration+" sec");if(adData!=null){console.debug("Data re not null ! ");$scope.isAdsDataHidden=false;$scope.AdsData=$sce.trustAsHtml(adData)}if(animate==true){console.debug("Animation is  Activated ! ");$scope.isAdsInfoHidden=false}console.debug("you ads will end in "+txtduration+" sec",$scope.isAdsInfoHidden,"<<>>",$scope.isAdsInfoHidden)};console.debug("fjOverlays : overlay triggred to start @ ",showAt," for ",txtduration,"sec ");trigger()};$scope.fjVideo=function(mediaConf){this.media=mediaConf,this.Startup=function(){$scope.movieTitle=this.media.title;if(this.media.type=="dash"){console.debug("Startup for Dash ");$scope.dash_context=new Dash.di.DashContext;$scope.dash_player=new MediaPlayer($scope.dash_context);$scope.dash_player.startup()}else{console.debug("Startup for NON Dash ");var source=document.createElement("source");source.src=this.media.src;source.type=this.media.type;$scope.video.appendChild(source)}},this.View=function(){if(this.media.type=="dash"){console.debug("View for Dash ");$scope.dash_player.attachView($scope.video);$scope.dash_player.setAutoPlay(true);$scope.dash_player.attachSource(this.media.src);$scope.dash_player.setAutoSwitchQuality(true)}else{console.debug("View for NON Dash ");$scope.video.play()}},this.setTracks=function(){var newObj,i;console.debug("setTracks ");$scope.movieTTime=$scope.video.duration;$scope.movieCTime=$scope.video.currentTime;$scope.movieBuffered=$scope.video.buffered;$scope.VolumeMgr.setVolume($scope.video.volume*100);$scope.moviePoster=this.media.poster;if(this.media.thumbs){console.debug("setTracks : Setting thumbs ");$scope.thumbMgr=new $scope.fjThumbs($scope.tiObj,$scope.tdObj,$scope.pbObj);var track=document.createElement("track");track.src=this.media.thumbs;track.kind="metadata";$scope.video.appendChild(track)}if(this.media.substitles){console.debug("setTracks : Setting substitles  ",this.media.substitles.length);for(i=0;i<this.media.substitles.length;i++){var track=document.createElement("track");track.kind="subtitles";track.src=this.media.substitles[i].src;track.srclang=this.media.substitles[i].srclang;track.label=this.media.substitles[i].label;$scope.video.appendChild(track)}}$scope.video.load();console.debug("after inserting tracks in video , we have > ",$scope.video);if($scope.video.audioTracks){console.debug("setTracks : Setting audioTracks  ",scope.video.audioTracks.length);for(i=0;i<$scope.video.audioTracks.length;i++){$scope.isContainsLangs=true;newObj={label:$scope.video.audioTracks[i].language,index:i,actif:true};$scope.tracksArray.audio.push(newObj)}}if($scope.video.textTracks){newObj={label:"off",index:-1,actif:true};$scope.tracksArray.subs.push(newObj);for(i=0;i<$scope.video.textTracks.length;i++){if($scope.video.textTracks[i].kind=="metadata"){$scope.indexThumbsTrack=i;console.debug(">>>> thumb track found @ ",i,">> ",$scope.video.textTracks[i]);$scope.isContainsThumbs=true}else if($scope.video.textTracks[i].kind=="subtitles"){newObj={label:$scope.video.textTracks[i].label,index:i,actif:false};$scope.tracksArray.subs.push(newObj);$scope.isContainsSubs=true}else{console.debug("unknown type of tracks ",$scope.video.textTracks[i].kind)}}if($scope.isContainsSubs||$scope.isContainsLangs){$scope.SettingMenuMgr=new $scope.fjSettingMenu($scope.menuObj,$scope.settingBtn);$scope.SettingMenuMgr.setSubs(-1)}}if(this.media.class=="ads"){$scope.isVideoisAds=true;console.debug("setTracks : Setting overlays  class > ADS >");$scope.overlays[0]=new $scope.fjOverlays(null,0,-1,true)}else{$scope.isVideoisAds=false;if(this.media.overlays){console.debug("setTracks : Setting overlays  class > Movie ",this.media.overlays.length);for(i=0;i<this.media.overlays.length;i++){$scope.overlays[i]=new $scope.fjOverlays(this.media.overlays[i].data,this.media.overlays[i].showAt,this.media.overlays[i].duration,this.media.overlays[i].animate)}}}console.debug(" Vide is an ADS >",$scope.isVideoisAds)}};$scope.goPrevPlaylist=function(){if($scope.isPlaying==true){$scope.isPlaying=false;$scope.video.pause()}$scope.videoReady=false;$scope.cleanVideoObject();if($scope.PlaylistCurrentIndex>0){$scope.PlaylistCurrentIndex--}else{$scope.PlaylistCurrentIndex=$scope.playerItems.length-1;if($scope.isPlaylistLoop==false){goBackHistory();return}}console.debug("Going Prev ",$scope.PlaylistCurrentIndex,"/",$scope.playerItems.length-1);$scope.medias[$scope.PlaylistCurrentIndex].Startup();$scope.medias[$scope.PlaylistCurrentIndex].setTracks();$scope.medias[$scope.PlaylistCurrentIndex].View()};$scope.goNextPlaylist=function(){if($scope.isPlaying==true){$scope.isPlaying=false;$scope.video.pause()}$scope.status="Loading ....";$scope.videoReady=false;$scope.cleanVideoObject();if($scope.PlaylistCurrentIndex<$scope.playerItems.length-1){$scope.PlaylistCurrentIndex++}else{$scope.PlaylistCurrentIndex=0;if($scope.isPlaylistLoop==false){goBackHistory();return}}console.debug("Going Next ",$scope.PlaylistCurrentIndex,"/",$scope.playerItems.length-1);$scope.medias[$scope.PlaylistCurrentIndex].Startup();$scope.medias[$scope.PlaylistCurrentIndex].setTracks();$scope.medias[$scope.PlaylistCurrentIndex].View()};$scope.goFullScreen=function(){console.info(" Asking to go Full Screen");if($scope.isFullScreen==true){if(document.exitFullscreen)document.exitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitCancelFullScreen)document.webkitCancelFullScreen();else if(document.msExitFullscreen)document.msExitFullscreen();$scope.isFullScreen=false}else{if($scope.video.requestFullscreen)$scope.video.requestFullscreen();else if($scope.video.mozRequestFullScreen)$scope.video.mozRequestFullScreen();else if($scope.video.webkitRequestFullScreen)$scope.video.webkitRequestFullScreen();else if($scope.video.msRequestFullscreen)$scope.video.msRequestFullscreen();$scope.isFullScreen=true}};$scope.goSeek=function($event){if($scope.video.seekable){var rect=$scope.pbObj.getBoundingClientRect();var p=($event.pageX-rect.left)*($scope.video.duration/(rect.right-rect.left));console.debug("seek to ",p,"sec ");if($scope.isPlaying==true){$scope.isPlaying=false;$scope.video.pause()}$scope.video.currentTime=p;$scope.isPlaying=true;$scope.video.play()}else{console.warn("seek is no supported on this video ")}};$scope.goBackHistory=function(){$window.history.back()};$scope.goPlay=function(){if($scope.isVideoisAds)return;if($scope.isPlaying==true){$scope.isPlaying=false;$scope.video.pause()}else{$scope.isPlaying=true;$scope.video.play()}};$scope.cleanVideoObject=function(){$scope.video.pause();$scope.tracksArray={subs:[],audio:[]};$scope.video.removeAttribute("src");while($scope.video.firstChild){$scope.video.removeChild($scope.video.firstChild)}delete $scope.settingMenuMgr;delete $scope.thumbMgr;$scope.dash_context=null;$scope.dash_player=null;$scope.overlays.splice(0,$scope.overlays.length);$scope.isContainsSubs=false;$scope.isContainsLangs=false;$scope.isContainsThumbs=false;$scope.prgressPercentage=0;$scope.movieTitle="";$scope.isAdsDataHidden=true;$scope.isAdsInfoHidden=true};$scope.onPlayVideoEvt=function(e){$scope.$apply(function(){$scope.isPlaying=true;console.info(" PLAY EVENT >>> on SRC  ",e.currentTarget.currentSrc)})},$scope.onPauseVideoEvt=function(e){$scope.$apply(function(){$scope.isPlaying=false;console.info(" PAUSE EVENT >>> on SRC  ",e.currentTarget.currentSrc)})};$scope.onCanPlayVideoEvt=function(e){$scope.$apply(function(){$scope.movieTTime=$scope.video.duration;$scope.movieCTime=$scope.video.currentTime;$scope.movieBuffered=$scope.video.buffered;$scope.VolumeMgr.setVolume($scope.video.volume*100);$scope.videoReady=true;console.info(" CANPLAY EVENT >>> on SRC  ",e.currentTarget.currentSrc)})};$scope.onEndedVideoEvt=function(e){$scope.$apply(function(){$scope.videoReady=false;if($scope.isPlaylist){$scope.goNextPlaylist()}console.info(" END EVENT >>> EVENT >>> on SRC  ",e.currentTarget.currentSrc)})};$scope.onLoadeddataVideoEvt=function(e){};$scope.onTimeupdateVideoEvt=function(e){$scope.$apply(function(){$scope.movieTTime=$scope.video.duration;$scope.movieCTime=$scope.video.currentTime;$scope.movieBuffered=$scope.video.buffered;$scope.volume=$scope.video.volume;$scope.prgressPercentage=$scope.movieCTime/$scope.movieTTime*100;if($scope.movieCTime==$scope.movieTTime){console.debug(" END >",$scope.prgressPercentage);$scope.isPlaying=false}})};$scope.onErrorVideoEvt=function(e){console.info(" ERROR EVENT >>> ",e)};$scope.onSeekingVideoEvt=function(e){$scope.isVideoSeeking=true;$scope.status="Seeking  ....";console.info(" onSeekingVideoEvt EVENT >>> ",e.currentTarget.currentSrc)};$scope.onSeekedVideoEvt=function(e){$scope.isVideoSeeking=false;console.info(" onSeekedVideoEvt EVENT >>> ",e.currentTarget.currentSrc)};$scope.SetVideoEvents=function(){$scope.video.addEventListener("error",$scope.onErrorVideoEvt.bind($scope.video));$scope.video.addEventListener("seeking",$scope.onSeekingVideoEvt.bind($scope.video));$scope.video.addEventListener("seeked",$scope.onSeekedVideoEvt.bind($scope.video));$scope.video.addEventListener("canplay",$scope.onCanPlayVideoEvt.bind($scope.video));$scope.video.addEventListener("loadeddata",$scope.onLoadeddataVideoEvt.bind($scope.video));$scope.video.addEventListener("timeupdate",$scope.onTimeupdateVideoEvt.bind($scope.video));$scope.video.addEventListener("play",$scope.onPlayVideoEvt.bind($scope.video));$scope.video.addEventListener("pause",$scope.onPauseVideoEvt.bind($scope.video));$scope.video.addEventListener("ended",$scope.onEndedVideoEvt.bind($scope.video))}}]).filter("duration",function(){return function(secDuration){var sec_num=parseInt(secDuration,10);var hours=Math.floor(sec_num/3600);var minutes=Math.floor((sec_num-hours*3600)/60);var seconds=sec_num-hours*3600-minutes*60;if(minutes<10){minutes="0"+minutes}if(seconds<10){seconds="0"+seconds}if(hours==0){return minutes+":"+seconds}else{if(hours<10){hours="0"+hours}return hours+":"+minutes+":"+seconds}}}).directive("fjPlayerjs",function(){return{restrict:"E",scope:{fjplayerdesc:"@",fjstartplaying:"@"},templateUrl:"/dist/fjplayer-tmpl.html",controller:"fjplayerCtrl",link:function(scope,iElement,iAttrs){scope.$watch("fjstartplaying",function(newValue){if(newValue=="true"){scope.prepareUI();scope.checkPlaylistAndStart(iAttrs.fjplayerdesc,0);console.debug("Start playing !!!")}else{console.debug("Schoud we Stop playing ?!",newValue);console.log(iAttrs.fjstartplaying)}})}}});